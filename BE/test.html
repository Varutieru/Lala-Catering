<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lala Catering - Full Flow Testing</title>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="text/javascript"
        src="https://app.sandbox.midtrans.com/snap/snap.js"
        data-client-key="Mid-server-aZA6ff-7dD3HB_J1ZfyXKqe7"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #667eea; margin-bottom: 20px; }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #f0f0f0;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
        }
        .tab.active { background: #667eea; color: white; font-weight: bold; }
        .tab:hover { background: #764ba2; color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sections */
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }
        .section h3 { color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
        .section h4 { color: #764ba2; margin: 15px 0 10px 0; }

        /* Status Badge */
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .status-bar strong { color: #667eea; }

        /* Forms */
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        button, input[type="submit"] {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }

        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-2px); }

        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; transform: translateY(-2px); }

        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; transform: translateY(-2px); }

        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; transform: translateY(-2px); }

        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* Cards */
        .card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        .card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }

        .order-card { border-left: 4px solid #667eea; }
        .order-card.paid { border-left-color: #ffc107; }
        .order-card.confirmed { border-left-color: #28a745; }
        .order-card.canceled { border-left-color: #dc3545; }
        .order-card.completed { border-left-color: #17a2b8; }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge.pending { background: #ffeaa7; color: #2d3436; }
        .badge.paid { background: #ffc107; color: #000; }
        .badge.confirmed { background: #28a745; color: white; }
        .badge.canceled { background: #dc3545; color: white; }
        .badge.completed { background: #17a2b8; color: white; }

        /* Menu Items */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .menu-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            text-align: center;
        }
        .menu-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px; }
        .menu-card h4 { color: #667eea; margin-bottom: 8px; }
        .menu-card .price { font-size: 18px; font-weight: bold; color: #28a745; margin: 8px 0; }
        .menu-card .stock { color: #666; font-size: 13px; }
        .menu-card input[type="number"] { width: 60px; text-align: center; }

        /* Flow Diagram */
        .flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(to right, #667eea, #764ba2);
            border-radius: 10px;
            color: white;
        }
        .flow-step {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
        }
        .flow-arrow { font-size: 24px; margin: 0 5px; }

        /* Logs */
        #logs {
            background: #2d3436;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry { margin-bottom: 5px; }
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #00bfff; }

        /* Responsive */
        @media (max-width: 768px) {
            .menu-grid { grid-template-columns: 1fr; }
            .flow { flex-direction: column; }
            .flow-arrow { transform: rotate(90deg); margin: 10px 0; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üçΩÔ∏è Lala Catering - Testing Hub</h1>
        <p class="subtitle">Comprehensive Testing for PAY FIRST, CONFIRM LATER Flow with Auto-Refund</p>

        <div class="status-bar">
            <strong>Login Status:</strong> <span id="userRole">Not Logged In</span> |
            <strong>User:</strong> <span id="userName">Guest</span> |
            <strong>Token:</strong> <span id="appTokenDisplay">N/A</span>
        </div>

        <!-- Payment Flow Diagram -->
        <div class="flow">
            <div class="flow-step">
                <div style="font-size: 30px;">üìù</div>
                <div>Create Order</div>
                <small>Status: pending</small>
            </div>
            <div class="flow-arrow">‚Üí</div>
            <div class="flow-step">
                <div style="font-size: 30px;">üí≥</div>
                <div>Pay via Midtrans</div>
                <small>Status: paid</small>
            </div>
            <div class="flow-arrow">‚Üí</div>
            <div class="flow-step">
                <div style="font-size: 30px;">üë§</div>
                <div>Seller Review</div>
                <small>Approve/Reject</small>
            </div>
            <div class="flow-arrow">‚Üí</div>
            <div class="flow-step">
                <div style="font-size: 30px;">‚úÖ</div>
                <div>Confirmed</div>
                <small>or ‚ùå Refund</small>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('auth')">üîê Authentication</button>
            <button class="tab" onclick="switchTab('customer')">üõí Customer Flow</button>
            <button class="tab" onclick="switchTab('seller')">üë®‚Äçüíº Seller Dashboard</button>
            <button class="tab" onclick="switchTab('menu')">üìã Menu Management</button>
            <button class="tab" onclick="switchTab('logs')">üìä System Logs</button>
        </div>

        <!-- AUTH TAB -->
        <div id="auth-tab" class="tab-content active">
            <div class="section">
                <h3>üîê Authentication</h3>

                <h4>Quick Login (Pre-configured)</h4>
                <button class="btn-success" onclick="quickLogin('pembeli')">Login as Customer (Pembeli)</button>
                <button class="btn-warning" onclick="quickLogin('penjual')">Login as Seller (Penjual)</button>

                <hr style="margin: 20px 0;">

                <h4>Traditional Login</h4>
                <form id="traditionalLoginForm">
                    <input type="email" id="loginEmail" placeholder="Email" value="pembeli@example.com">
                    <input type="password" id="loginPassword" placeholder="Password" value="pembeli123">
                    <button type="submit" class="btn-primary">Login</button>
                </form>

                <h4>Register New User</h4>
                <form id="registrationForm">
                    <input type="text" id="registerName" placeholder="Full Name" required>
                    <input type="email" id="registerEmail" placeholder="Email" required>
                    <input type="password" id="registerPassword" placeholder="Password (min 6 chars)" required>
                    <select id="registerRole">
                        <option value="pembeli">Customer (Pembeli)</option>
                        <option value="penjual">Seller (Penjual)</option>
                    </select>
                    <input type="text" id="registerPhone" placeholder="Phone Number" required>
                    <input type="text" id="registerAddress" placeholder="Delivery Address" required>
                    <button type="submit" class="btn-success">Register</button>
                </form>

                <h4>Google OAuth Login</h4>
                <div id="g_id_onload" data-client_id="458932019092-3s36elfsoko1q4iqns7l0hmel0aibk82.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
                <div class="g_id_signin" data-type="standard"></div>
            </div>
        </div>

        <!-- CUSTOMER TAB -->
        <div id="customer-tab" class="tab-content">
            <div class="section">
                <h3>üõí Customer Flow - Order & Payment</h3>

                <h4>Step 1: Browse Available Menu</h4>
                <button class="btn-info" onclick="fetchAndDisplayMenu()">üîÑ Refresh Menu List</button>
                <div id="availableMenuList" class="menu-grid"></div>

                <h4>Step 2: Create Order & Pay Immediately</h4>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>üìå Note:</strong> Payment akan langsung dilakukan via Midtrans setelah order dibuat.
                    Setelah pembayaran berhasil, pesanan akan menunggu konfirmasi dari seller.
                </div>

                <label>Metode Pengambilan:</label>
                <select id="metodePengambilan">
                    <option value="delivery">Delivery (Antar)</option>
                    <option value="pickup">Pickup (Ambil Sendiri)</option>
                </select>

                <label>Lokasi Pengiriman (optional, for demo):</label>
                <input type="text" id="deliveryLat" placeholder="Latitude" value="-6.2088">
                <input type="text" id="deliveryLng" placeholder="Longitude" value="106.8456">

                <button class="btn-primary" onclick="createOrderAndPay()" style="font-size: 16px; padding: 15px 30px;">
                    üí≥ Create Order & Pay Now
                </button>

                <h4>Step 3: My Orders</h4>
                <button class="btn-info" onclick="fetchMyOrders()">üìã View My Orders</button>
                <div id="myOrdersList"></div>
            </div>
        </div>

        <!-- SELLER TAB -->
        <div id="seller-tab" class="tab-content">
            <div class="section">
                <h3>üë®‚Äçüíº Seller Dashboard - Approve/Reject Orders</h3>

                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>üìå Seller Actions:</strong><br>
                    ‚Ä¢ View all orders with status <span class="badge paid">PAID</span><br>
                    ‚Ä¢ <strong>APPROVE</strong> order if you can handle it ‚Üí Status: confirmed, Stock reduced<br>
                    ‚Ä¢ <strong>REJECT</strong> order if capacity full ‚Üí Auto-refund via Midtrans API
                </div>

                <button class="btn-info" onclick="fetchAllOrders()">üîÑ Refresh All Orders</button>

                <h4>Paid Orders (Waiting Confirmation)</h4>
                <div id="paidOrdersList"></div>

                <h4>All Orders</h4>
                <div id="allOrdersList"></div>
            </div>
        </div>

        <!-- MENU MANAGEMENT TAB -->
        <div id="menu-tab" class="tab-content">
            <div class="section">
                <h3>üìã Menu Management (Seller Only)</h3>

                <h4>Add New Menu Item</h4>
                <form id="menuForm">
                    <input type="text" id="menuName" placeholder="Menu Name" required>
                    <textarea id="menuDescription" placeholder="Description" rows="3" required></textarea>
                    <input type="number" id="menuPrice" placeholder="Price (Rp)" required>
                    <input type="number" id="menuStock" placeholder="Initial Stock" value="10" required>
                    <input type="file" id="menuImage" accept="image/*">
                    <button type="submit" class="btn-success">‚ûï Add Menu</button>
                </form>

                <h4>Current Menu Items</h4>
                <button class="btn-info" onclick="fetchAndDisplayMenu()">üîÑ Refresh</button>
                <div id="menuManagementList" class="menu-grid"></div>

                <h4>Set Weekly Schedule</h4>
                <button class="btn-warning" onclick="setWeeklySchedule()">üìÖ Set Schedule for This Week</button>
            </div>
        </div>

        <!-- LOGS TAB -->
        <div id="logs-tab" class="tab-content">
            <div class="section">
                <h3>üìä System Logs</h3>
                <button class="btn-danger" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                <div id="logs"></div>
            </div>
        </div>

    </div>

    <script>
        const backendUrl = 'http://localhost:3000/api';
        let appToken = '';
        let userRole = '';
        let userName = '';
        let availableMenus = [];
        let selectedItems = [];

        // ===== TAB SWITCHING =====
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            addLog(`Switched to ${tabName} tab`, 'info');
        }

        // ===== LOGGING SYSTEM =====
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : 'log-info');
            logsDiv.innerHTML = `<div class="log-entry ${logClass}">[${timestamp}] ${message}</div>` + logsDiv.innerHTML;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        // ===== AUTHENTICATION =====
        async function handleAuthSuccess(token, role, nama, email) {
            appToken = token;
            userRole = role;
            userName = nama;

            document.getElementById('appTokenDisplay').innerText = token.substring(0, 30) + '...';
            document.getElementById('userRole').innerText = role.toUpperCase();
            document.getElementById('userName').innerText = nama;

            addLog(`‚úÖ Login successful as ${nama} (${role})`, 'success');
            alert(`Login Berhasil!\n\nNama: ${nama}\nRole: ${role}\nEmail: ${email}`);

            fetchAndDisplayMenu();
        }

        async function quickLogin(role) {
            const credentials = {
                pembeli: { email: 'pembeli@example.com', password: 'pembeli123' },
                penjual: { email: 'penjual@example.com', password: 'penjual123' }
            };

            const cred = credentials[role];
            document.getElementById('loginEmail').value = cred.email;
            document.getElementById('loginPassword').value = cred.password;

            addLog(`Quick login as ${role}...`, 'info');
            await loginUser(cred.email, cred.password);
        }

        async function loginUser(email, password) {
            try {
                addLog(`Attempting login for ${email}...`, 'info');
                const res = await axios.post(`${backendUrl}/users/login`, { email, password });
                handleAuthSuccess(res.data.token, res.data.user.role, res.data.user.nama, res.data.user.email);
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Login failed: ${msg}`, 'error');
                alert('Login Gagal: ' + msg);
            }
        }

        document.getElementById('traditionalLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            loginUser(email, password);
        });

        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                nama: document.getElementById('registerName').value,
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value,
                role: document.getElementById('registerRole').value,
                nomorTelepon: document.getElementById('registerPhone').value,
                alamatPengiriman: document.getElementById('registerAddress').value
            };

            try {
                addLog(`Registering user ${data.email}...`, 'info');
                await axios.post(`${backendUrl}/users/register`, data);
                addLog(`‚úÖ Registration successful for ${data.email}`, 'success');
                alert('Registrasi Berhasil! Silakan login.');
                document.getElementById('registrationForm').reset();
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Registration failed: ${msg}`, 'error');
                alert('Registrasi Gagal: ' + msg);
            }
        });

        async function handleCredentialResponse(response) {
            try {
                addLog('Processing Google OAuth...', 'info');
                const res = await axios.post(`${backendUrl}/users/auth/google`, { token: response.credential });
                handleAuthSuccess(res.data.token, res.data.user.role, res.data.user.nama, res.data.user.email);
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Google login failed: ${msg}`, 'error');
                alert('Google Login Gagal: ' + msg);
            }
        }

        // ===== MENU MANAGEMENT =====
        async function fetchAndDisplayMenu() {
            try {
                addLog('Fetching menu items...', 'info');
                const res = await axios.get(`${backendUrl}/menu`);
                availableMenus = res.data;

                // Display for customers (with checkboxes)
                const customerMenuDiv = document.getElementById('availableMenuList');
                customerMenuDiv.innerHTML = '';

                // Display for menu management
                const managementMenuDiv = document.getElementById('menuManagementList');
                managementMenuDiv.innerHTML = '';

                if (availableMenus.length === 0) {
                    customerMenuDiv.innerHTML = '<p>No menu items available.</p>';
                    managementMenuDiv.innerHTML = '<p>No menu items available.</p>';
                    return;
                }

                availableMenus.forEach(menu => {
                    // Customer view
                    const customerCard = `
                        <div class="menu-card">
                            <img src="${menu.imageUrl || 'https://via.placeholder.com/250x150?text=No+Image'}" alt="${menu.nama}">
                            <h4>${menu.nama}</h4>
                            <p>${menu.deskripsi}</p>
                            <div class="price">Rp ${menu.harga.toLocaleString()}</div>
                            <div class="stock">Stock: ${menu.stok}</div>
                            <label>
                                <input type="checkbox" class="menu-checkbox" data-id="${menu._id}" data-nama="${menu.nama}" data-harga="${menu.harga}">
                                Select
                            </label>
                            <input type="number" class="item-jumlah" data-id="${menu._id}" min="0" max="${menu.stok}" value="0" style="margin-top: 8px;">
                        </div>
                    `;
                    customerMenuDiv.innerHTML += customerCard;

                    // Management view
                    const managementCard = `
                        <div class="menu-card">
                            <img src="${menu.imageUrl || 'https://via.placeholder.com/250x150?text=No+Image'}" alt="${menu.nama}">
                            <h4>${menu.nama}</h4>
                            <p>${menu.deskripsi}</p>
                            <div class="price">Rp ${menu.harga.toLocaleString()}</div>
                            <div class="stock">Stock: ${menu.stok}</div>
                        </div>
                    `;
                    managementMenuDiv.innerHTML += managementCard;
                });

                addLog(`‚úÖ Loaded ${availableMenus.length} menu items`, 'success');
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to fetch menu: ${msg}`, 'error');
            }
        }

        document.getElementById('menuForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (userRole !== 'penjual') {
                alert('Only sellers can add menu items!');
                return;
            }

            const formData = new FormData();
            formData.append('nama', document.getElementById('menuName').value);
            formData.append('deskripsi', document.getElementById('menuDescription').value);
            formData.append('harga', document.getElementById('menuPrice').value);
            formData.append('stok', document.getElementById('menuStock').value);

            const fileInput = document.getElementById('menuImage');
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }

            try {
                addLog('Adding new menu item...', 'info');
                await axios.post(`${backendUrl}/menu`, formData, {
                    headers: {
                        'x-auth-token': appToken,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                addLog('‚úÖ Menu item added successfully', 'success');
                alert('Menu berhasil ditambahkan!');
                document.getElementById('menuForm').reset();
                fetchAndDisplayMenu();
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to add menu: ${msg}`, 'error');
                alert('Gagal menambah menu: ' + msg);
            }
        });

        async function setWeeklySchedule() {
            if (userRole !== 'penjual') {
                alert('Only sellers can set schedules!');
                return;
            }

            if (availableMenus.length === 0) {
                alert('Please add menu items first!');
                return;
            }

            const today = new Date();
            const weeklySchedule = [];

            for (let i = 0; i < 7; i++) {
                const scheduleDate = new Date(today);
                scheduleDate.setDate(today.getDate() + i);
                const availableMenuIds = availableMenus.map(m => m._id);
                weeklySchedule.push({
                    tanggal: scheduleDate.toISOString(),
                    menuTersedia: availableMenuIds,
                    statusToko: 'buka'
                });
            }

            try {
                addLog('Setting weekly schedule...', 'info');
                await axios.post(`${backendUrl}/jadwal/weekly`, weeklySchedule, {
                    headers: { 'x-auth-token': appToken }
                });
                addLog('‚úÖ Weekly schedule set successfully', 'success');
                alert('Jadwal mingguan berhasil diatur!');
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to set schedule: ${msg}`, 'error');
                alert('Gagal mengatur jadwal: ' + msg);
            }
        }

        // ===== CUSTOMER ORDER & PAYMENT =====
        async function createOrderAndPay() {
            if (!appToken || userRole !== 'pembeli') {
                alert('Please login as a customer (pembeli) first!');
                addLog('‚ùå Must be logged in as pembeli to create order', 'error');
                return;
            }

            try {
                // Collect selected items
                selectedItems = [];
                document.querySelectorAll('.menu-checkbox:checked').forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    const jumlahInput = document.querySelector(`.item-jumlah[data-id="${id}"]`);
                    const jumlah = parseInt(jumlahInput.value);

                    if (jumlah > 0) {
                        selectedItems.push({
                            menuItemId: id,
                            jumlah: jumlah
                        });
                    }
                });

                if (selectedItems.length === 0) {
                    alert('Please select at least one menu item with quantity > 0');
                    return;
                }

                addLog(`Creating order with ${selectedItems.length} items...`, 'info');

                const orderData = {
                    items: selectedItems,
                    lokasiPengiriman: {
                        lat: parseFloat(document.getElementById('deliveryLat').value),
                        lng: parseFloat(document.getElementById('deliveryLng').value)
                    },
                    metodePengambilan: document.getElementById('metodePengambilan').value
                };

                // Step 1: Create Order
                const orderRes = await axios.post(`${backendUrl}/orders`, orderData, {
                    headers: { 'x-auth-token': appToken }
                });
                const orderId = orderRes.data._id;
                addLog(`‚úÖ Order created: ${orderId}`, 'success');

                // Step 2: Get Payment Token
                addLog(`Getting payment token for order ${orderId}...`, 'info');
                const checkoutRes = await axios.post(`${backendUrl}/orders/${orderId}/checkout`, {}, {
                    headers: { 'x-auth-token': appToken }
                });
                const snapToken = checkoutRes.data.token;
                addLog(`‚úÖ Payment token received`, 'success');

                // Step 3: Open Midtrans Snap
                addLog(`Opening Midtrans payment gateway...`, 'info');
                window.snap.pay(snapToken, {
                    onSuccess: function(result) {
                        addLog(`‚úÖ PAYMENT SUCCESS for order ${orderId}`, 'success');
                        alert("‚úÖ Pembayaran Berhasil!\n\nPesanan Anda sedang menunggu konfirmasi dari penjual.");
                        console.log(result);
                        fetchMyOrders();
                    },
                    onPending: function(result) {
                        addLog(`‚è≥ Payment pending for order ${orderId}`, 'info');
                        alert("‚è≥ Pembayaran Pending\n\nSilakan selesaikan pembayaran Anda.");
                        console.log(result);
                    },
                    onError: function(result) {
                        addLog(`‚ùå Payment error for order ${orderId}`, 'error');
                        alert("‚ùå Pembayaran Gagal!");
                        console.log(result);
                    },
                    onClose: function() {
                        addLog(`Payment window closed for order ${orderId}`, 'info');
                        alert('‚ö†Ô∏è Anda menutup popup pembayaran sebelum menyelesaikan transaksi.');
                    }
                });
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Order creation failed: ${msg}`, 'error');
                alert('Gagal membuat pesanan: ' + msg);
            }
        }

        async function fetchMyOrders() {
            if (!appToken || userRole !== 'pembeli') {
                alert('Please login as customer first!');
                return;
            }

            try {
                addLog('Fetching my orders...', 'info');
                const res = await axios.get(`${backendUrl}/orders/myorders`, {
                    headers: { 'x-auth-token': appToken }
                });

                const orders = res.data;
                const listDiv = document.getElementById('myOrdersList');

                if (orders.length === 0) {
                    listDiv.innerHTML = '<p>You have no orders yet.</p>';
                    return;
                }

                listDiv.innerHTML = '';
                orders.forEach(order => {
                    const statusClass = order.status.toLowerCase();
                    const card = `
                        <div class="card order-card ${statusClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Order ID:</strong> ${order._id}<br>
                                    <strong>Status:</strong> <span class="badge ${statusClass}">${order.status}</span><br>
                                    <strong>Total:</strong> Rp ${order.totalHarga.toLocaleString()}<br>
                                    <strong>Method:</strong> ${order.metodePengambilan}<br>
                                    <strong>Date:</strong> ${new Date(order.tanggalPesanan).toLocaleString()}
                                </div>
                                <div>
                                    <button class="btn-info" onclick="viewOrderDetail('${order._id}')">View Details</button>
                                </div>
                            </div>
                        </div>
                    `;
                    listDiv.innerHTML += card;
                });

                addLog(`‚úÖ Loaded ${orders.length} orders`, 'success');
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to fetch orders: ${msg}`, 'error');
                alert('Gagal memuat pesanan: ' + msg);
            }
        }

        // ===== SELLER DASHBOARD =====
        async function fetchAllOrders() {
            if (!appToken || userRole !== 'penjual') {
                alert('Please login as seller first!');
                return;
            }

            try {
                addLog('Fetching all orders...', 'info');
                const res = await axios.get(`${backendUrl}/orders`, {
                    headers: { 'x-auth-token': appToken }
                });

                const orders = res.data;
                const paidOrders = orders.filter(o => o.status === 'paid');
                const allOrdersDiv = document.getElementById('allOrdersList');
                const paidOrdersDiv = document.getElementById('paidOrdersList');

                // Display paid orders (need approval)
                if (paidOrders.length === 0) {
                    paidOrdersDiv.innerHTML = '<p>No paid orders waiting for confirmation.</p>';
                } else {
                    paidOrdersDiv.innerHTML = '';
                    paidOrders.forEach(order => {
                        const card = createSellerOrderCard(order, true);
                        paidOrdersDiv.innerHTML += card;
                    });
                }

                // Display all orders
                if (orders.length === 0) {
                    allOrdersDiv.innerHTML = '<p>No orders yet.</p>';
                } else {
                    allOrdersDiv.innerHTML = '';
                    orders.forEach(order => {
                        const card = createSellerOrderCard(order, false);
                        allOrdersDiv.innerHTML += card;
                    });
                }

                addLog(`‚úÖ Loaded ${orders.length} orders (${paidOrders.length} waiting confirmation)`, 'success');
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to fetch orders: ${msg}`, 'error');
                alert('Gagal memuat pesanan: ' + msg);
            }
        }

        function createSellerOrderCard(order, showActions) {
            const statusClass = order.status.toLowerCase();
            const itemsList = order.items.map(item =>
                `${item.namaItem} x${item.jumlah} (Rp ${(item.harga * item.jumlah).toLocaleString()})`
            ).join('<br>');

            // Determine which actions to show based on order status
            let actions = '';
            if (showActions && order.status === 'paid') {
                // Show approve/reject for paid orders
                actions = `
                    <button class="btn-success" onclick="approveOrder('${order._id}')">‚úÖ Approve</button>
                    <button class="btn-danger" onclick="rejectOrder('${order._id}')">‚ùå Reject & Refund</button>
                `;
            } else if (order.status === 'confirmed') {
                // Show complete button for confirmed orders
                actions = `
                    <button class="btn-info" onclick="completeOrder('${order._id}')">‚úì Mark as Completed</button>
                `;
            }

            return `
                <div class="card order-card ${statusClass}">
                    <div style="display: flex; justify-content: space-between;">
                        <div style="flex: 1;">
                            <strong>Order ID:</strong> ${order._id}<br>
                            <strong>Customer:</strong> ${order.userInfo?.nama || 'N/A'} (${order.userInfo?.email || 'N/A'})<br>
                            <strong>Phone:</strong> ${order.userInfo?.nomorTelepon || 'N/A'}<br>
                            <strong>Status:</strong> <span class="badge ${statusClass}">${order.status}</span><br>
                            <strong>Method:</strong> ${order.metodePengambilan}<br>
                            <strong>Total:</strong> Rp ${order.totalHarga.toLocaleString()}<br>
                            <strong>Date:</strong> ${new Date(order.tanggalPesanan).toLocaleString()}<br>
                            <strong>Items:</strong><br>${itemsList}
                        </div>
                        <div style="text-align: right;">
                            ${actions}
                        </div>
                    </div>
                </div>
            `;
        }

        async function approveOrder(orderId) {
            if (!confirm('Approve this order?\n\nStock will be reduced and order will be confirmed.')) {
                return;
            }

            try {
                addLog(`Approving order ${orderId}...`, 'info');
                const res = await axios.post(`${backendUrl}/orders/${orderId}/approve`, {}, {
                    headers: { 'x-auth-token': appToken }
                });

                addLog(`‚úÖ Order ${orderId} approved successfully`, 'success');
                alert('‚úÖ Pesanan Berhasil Diapprove!\n\nStock telah dikurangi dan customer akan menerima notifikasi email.');
                fetchAllOrders();
                fetchAndDisplayMenu(); // Refresh to show updated stock
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to approve order: ${msg}`, 'error');
                alert('Gagal approve pesanan: ' + msg);
            }
        }

        async function rejectOrder(orderId) {
            const reason = prompt('Reject this order?\n\nPlease provide a reason (will be sent to customer via email):');

            if (!reason) {
                alert('Rejection cancelled. Reason is required.');
                return;
            }

            try {
                addLog(`Rejecting order ${orderId}...`, 'info');
                const res = await axios.post(`${backendUrl}/orders/${orderId}/reject`,
                    { reason },
                    { headers: { 'x-auth-token': appToken } }
                );

                addLog(`‚úÖ Order ${orderId} rejected, refund initiated`, 'success');
                alert('‚úÖ Pesanan Ditolak & Refund Diproses!\n\nCustomer akan menerima email notifikasi dan uang akan dikembalikan dalam 1-3 hari kerja.');
                fetchAllOrders();
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to reject order: ${msg}`, 'error');
                alert('Gagal reject pesanan: ' + msg);
            }
        }

        async function completeOrder(orderId) {
            if (!confirm('Mark this order as completed?\n\nThis action confirms the order has been fulfilled.')) {
                return;
            }

            try {
                addLog(`Completing order ${orderId}...`, 'info');
                const res = await axios.post(`${backendUrl}/orders/${orderId}/complete`, {}, {
                    headers: { 'x-auth-token': appToken }
                });

                addLog(`‚úÖ Order ${orderId} marked as completed`, 'success');
                alert('‚úÖ Pesanan Selesai!\n\nCustomer akan menerima notifikasi email.');
                fetchAllOrders();
            } catch (error) {
                const msg = error.response?.data?.message || error.message;
                addLog(`‚ùå Failed to complete order: ${msg}`, 'error');
                alert('Gagal menyelesaikan pesanan: ' + msg);
            }
        }

        async function viewOrderDetail(orderId) {
            alert('Order detail view coming soon!\nOrder ID: ' + orderId);
        }

        // ===== INITIALIZATION =====
        window.onload = function() {
            addLog('üöÄ Lala Catering Testing Hub initialized', 'success');
            addLog('Please login to start testing', 'info');
            fetchAndDisplayMenu();
        }
    </script>
</body>
</html>
